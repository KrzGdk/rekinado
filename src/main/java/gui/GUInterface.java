package main.java.gui;

import java.awt.Color;
import java.awt.Graphics;
import java.awt.Graphics2D;
import main.java.gui.RekinadoMain.UIListener;
import java.awt.Polygon;
import main.java.simulation.Simulation;
import main.java.trees.TreeGUI;

public class GUInterface extends javax.swing.JFrame{

	private static boolean started = false;
	private GUIInfo infoBox = null;
	
	public GUInterface() {
		initComponents();
		if (!started) {
			this.add(BG);
			started = true;
			start();
		}
	}

	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel3 = new javax.swing.JPanel();
        btnReset = new javax.swing.JButton();
        btnSim = new javax.swing.JButton();
        BG = new javax.swing.JPanel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentResized(java.awt.event.ComponentEvent evt) {
                formComponentResized(evt);
            }
        });

        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)), "kontrola"));
        jPanel3.setName("nowa krzyzowka"); // NOI18N

        btnReset.setText("Reset");
        btnReset.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                btnResetMouseClicked(evt);
            }
        });
        btnReset.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnResetActionPerformed(evt);
            }
        });

        btnSim.setText("Symuluj");
        btnSim.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                btnSimMouseClicked(evt);
            }
        });
        btnSim.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSimActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addComponent(btnReset, javax.swing.GroupLayout.PREFERRED_SIZE, 88, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnSim, javax.swing.GroupLayout.PREFERRED_SIZE, 88, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                .addComponent(btnReset)
                .addComponent(btnSim))
        );

        BG.setBackground(new java.awt.Color(255, 255, 255));
        BG.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        BG.addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentResized(java.awt.event.ComponentEvent evt) {
                BGComponentResized(evt);
            }
        });

        javax.swing.GroupLayout BGLayout = new javax.swing.GroupLayout(BG);
        BG.setLayout(BGLayout);
        BGLayout.setHorizontalGroup(
            BGLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 772, Short.MAX_VALUE)
        );
        BGLayout.setVerticalGroup(
            BGLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 408, Short.MAX_VALUE)
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(BG, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(BG, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnResetMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_btnResetMouseClicked
		listener.actualizeUI(this);
		listener.reset();
    }//GEN-LAST:event_btnResetMouseClicked

    private void formComponentResized(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_formComponentResized
       //print(lab);
    }//GEN-LAST:event_formComponentResized

    private void BGComponentResized(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_BGComponentResized
       //print();
    }//GEN-LAST:event_BGComponentResized

    private void btnResetActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnResetActionPerformed
        
    }//GEN-LAST:event_btnResetActionPerformed

    private void btnSimMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_btnSimMouseClicked
        listener.actualizeUI(this);
		listener.simulate();
    }//GEN-LAST:event_btnSimMouseClicked

    private void btnSimActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSimActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_btnSimActionPerformed

	public static void start() {
		/* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
		 * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
		 */
		try {
			for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
				if ("Nimbus".equals(info.getName())) {
					javax.swing.UIManager.setLookAndFeel(info.getClassName());
					break;
				}
			}
		} catch (ClassNotFoundException ex) {
			java.util.logging.Logger.getLogger(GUInterface.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (InstantiationException ex) {
			java.util.logging.Logger.getLogger(GUInterface.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (IllegalAccessException ex) {
			java.util.logging.Logger.getLogger(GUInterface.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		} catch (javax.swing.UnsupportedLookAndFeelException ex) {
			java.util.logging.Logger.getLogger(GUInterface.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		}
        //</editor-fold>

		/* Create and display the form */
		java.awt.EventQueue.invokeLater(new Runnable() {
			public void run() {
				new GUInterface().setVisible(true);
			}
		});
	}

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel BG;
    private javax.swing.JButton btnReset;
    private javax.swing.JButton btnSim;
    private javax.swing.JPanel jPanel3;
    // End of variables declaration//GEN-END:variables
       
	private static UIListener listener;
	public void addListener(UIListener l) {
		listener = l;
	}
	public void fileNotFound() {
		dialog("Nie znaleziono pliku");
	}
	private void dialog(String text){
		if(infoBox == null) infoBox = new GUIInfo(this, false);
		infoBox.setVisible(false);
		infoBox.setLocationRelativeTo(this);
		infoBox.setText(text);
		//infoBox.setTitle(text);
		infoBox.setVisible(true);
	}
	
	private int bgWidth ;
	private int bgHeight ;
	public void clearBG(Graphics g){
		bgWidth  = BG.getWidth();
		bgHeight = BG.getHeight();
		g.setColor(Color.white);
		g.fillRect(1, 1, bgWidth - 2, bgHeight - 2);
	}
	
	private static int printscale = 2;
	private static double sin45 = .70710678118654752440084436210484903928483593768847;
	public static int toIzoX(double x, double y, double z){
		return (int) Math.round((x+sin45*y)*printscale);
	}
	public static int toIzoY(double x, double y, double z){
		return (int)-Math.round((z+sin45*y)*printscale);
	}
	
	public static int toIzoX(double tab[]){
		return (int) Math.round((tab[0]*6+sin45*tab[1]*6)*printscale);
	}
	public static int toIzoY(double tab[]){
		return (int)-Math.round((tab[2]+sin45*tab[1]*6)*printscale);
	}
	private Polygon normToCenter(Polygon p){ // To center of Word
		for(int i=0; i<p.npoints;i++){
			p.xpoints[i]+=(bgWidth/2 );
			p.ypoints[i]+=(bgHeight/2);
		}
		return p;
	}

	
	private void drawTerrain(Graphics g){
		int terrainWidth = Simulation.forestLength;
		int terrainHeight = Simulation.forestWidth;
		int terrainBold = 10;
		
		int[] xUp = new int[4];
		int[] yUp = new int[4];
		
		double[] p1 = {-terrainWidth/2,-terrainHeight/2,0};
		double[] p2 = { terrainWidth/2,-terrainHeight/2,0};
		double[] p3 = { terrainWidth/2, terrainHeight/2,0};
		double[] p4 = {-terrainWidth/2, terrainHeight/2,0};
		
		double[] d1 = {-terrainWidth/2,-terrainHeight/2,-terrainBold};
		double[] d2 = { terrainWidth/2,-terrainHeight/2,-terrainBold};
		double[] d3 = { terrainWidth/2,-terrainHeight/2,0};
		double[] d4 = {-terrainWidth/2,-terrainHeight/2,0};
		
		double[] l1 = { terrainWidth/2,-terrainHeight/2,-terrainBold};
		double[] l2 = { terrainWidth/2, terrainHeight/2,-terrainBold};
		double[] l3 = { terrainWidth/2, terrainHeight/2,0};
		double[] l4 = { terrainWidth/2,-terrainHeight/2,0};
		
		xUp[0] = toIzoX(p1);
		xUp[1] = toIzoX(p2);
		xUp[2] = toIzoX(p3);
		xUp[3] = toIzoX(p4);
		
		yUp[0] = toIzoY(p1);
		yUp[1] = toIzoY(p2);
		yUp[2] = toIzoY(p3);
		yUp[3] = toIzoY(p4);
		
		g.setColor(new Color(35, 92, 39));
		g.fillPolygon(normToCenter(new Polygon(xUp, yUp, 4)));
		
		
		xUp[0] = toIzoX(d1);
		xUp[1] = toIzoX(d2);
		xUp[2] = toIzoX(d3);
		xUp[3] = toIzoX(d4);
		
		yUp[0] = toIzoY(d1);
		yUp[1] = toIzoY(d2);
		yUp[2] = toIzoY(d3);
		yUp[3] = toIzoY(d4);
		
		g.setColor(new Color(150, 100, 55));
		g.fillPolygon(normToCenter(new Polygon(xUp, yUp, 4)));
		
		xUp[0] = toIzoX(l1);
		xUp[1] = toIzoX(l2);
		xUp[2] = toIzoX(l3);
		xUp[3] = toIzoX(l4);
		
		yUp[0] = toIzoY(l1);
		yUp[1] = toIzoY(l2);
		yUp[2] = toIzoY(l3);
		yUp[3] = toIzoY(l4);
		
		g.setColor(new Color(100, 50, 5));
		g.fillPolygon(normToCenter(new Polygon(xUp, yUp, 4)));
	}
	
	private void sortTrees(TreeGUI tree[], int ntree){
		TreeGUI temp;
		for(int i=0;i<ntree-1;i++){
			for(int j=0;j<ntree-i-1;j++){
				if(tree[j].x-tree[j].y>tree[j+1].x-tree[j+1].y){
					temp = tree[j];
					tree[j] = tree[j+1];
					tree[j+1]= temp;
				}
			}			
		}
	}
	public void printFrame(TreeGUI tree[], int ntree) {
		Graphics g = BG.getGraphics();
		clearBG(g);
		drawTerrain(g);
		
		sortTrees(tree, ntree);
		
		for(int i=0; i<ntree;i++){
			g.setColor(tree[i].getTrunkColor());
			g.fillPolygon(normToCenter(tree[i].getTrunk()));
			g.setColor(tree[i].getCrownColor());
			g.fillPolygon(normToCenter(tree[i].getCrown()));
		}
		printMiniature(g, tree, ntree);
	}	
	
	private void printMiniature(Graphics g, TreeGUI tree[], int ntree){
		int x = 3;
		int y = 3;
		int h = 200;
		int w = 200;
		int terrainWidth = Simulation.forestLength;
		int terrainHeight = Simulation.forestWidth;
		
		int treeX;
		int treeY;
		
		int Xr = (w/terrainWidth );
		int Yr = (h/terrainHeight);
		int treeXs;
		int treeYs;
		
		double angle;
		
		g.setColor(Color.black);
		g.fillRect(x-1, y-1, w+2, h+2);
		g.setColor(Color.white);
		g.fillRect(x, y, w, h);
		for(int i=0;i<ntree;i++){
			treeX = (int) (x+( tree[i].x+.5)*Xr+w/2);
			treeY = (int) (y+(-tree[i].y-.5)*Yr+h/2);
			treeXs = (int) ((Xr-2)*tree[i].windPower +1);
			treeYs = (int) ((Yr-2)*tree[i].windPower +1);
			angle = tree[i].windRotation*Math.PI;
			g.setColor(tree[i].getCrownColor());			
			g.drawLine(treeX,treeY,treeX+(int)(treeXs*Math.sin(angle)),treeY+(int)(treeYs*Math.cos(angle)));
		}
	}
}
